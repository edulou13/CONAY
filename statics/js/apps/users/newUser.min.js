/*!
* auhtor: Luis Eduardo Miranda Barja
* (C) 2015 - mbarjaedu13@gmail.com
*/
$(function(){$(".manager-menu, .user-sub").addClass("active"),$("#cancel, .back").on({click:function(e){e.preventDefault(),location.href="/usuarios/gestion"}});var e=$("#inputRol"),s=e.closest(".form-group").next(),o=$(".redes_salud"),t=$(".municipios"),a=$(".centros_salud"),n=function(e){for(var s=[$("<option/>",{value:-1,text:"-- Elija Una --"})],o=0;o<e.length;o++){var t=e[o],a=$("<option/>",{value:t.id_red,text:t.nombre}).data({municipios:t.municipios,centros:t.centros});s.push(a)}return s.length>1?s:[$("<option/>",{value:-1,text:"-- Sin Redes de Salud --"})]},i=function(e){for(var s=[$("<option/>",{value:-1,text:"-- Elija Uno --"})],o=0;o<e.length;o++){var t=e[o],a=$("<option/>",{value:t.id_mup,text:t.nombre});s.push(a)}return s.length>1?s:[$("<option/>",{value:-1,text:"-- Sin Municipios --"})]},l=function(e){for(var s=[$("<option/>",{value:-1,text:"-- Elija Uno --"})],o=0;o<e.length;o++){var t=e[o],a=$("<option/>",{value:t.id_cen,text:t.nombre});s.push(a)}return s.length>1?s:[$("<option/>",{value:-1,text:"-- Sin Establecimientos --"})]};s.disable().hide(),o.disable().hide(),t.disable().hide(),a.disable().hide(),$.post("/redes_salud/disponibles",data={_xsrf:getCookie("_xsrf")},function(e){"array"==$.type(e)&&o.find("select").html(n(e))}),$("#inputLogin").on({blur:function(e){var s=$(this).val(),o=$(this);s.length>5&&$.post("/usuarios/v_login",data={_xsrf:getCookie("_xsrf"),login:s},function(e){e?($("button[type=submit]").disable(),o.val("").focus().closest(".form-group").removeClass("has-success").addClass("has-error").find("span").removeClass("fa-check").addClass("fa fa-time"),swal({title:"Error!",text:'"'+s+'", no está disponible!.\nPor favor elija otro.',type:"error",confirmButtonText:"Continuar",closeOnConfirm:!1})):($("button[type=submit]").enable(),o.closest(".form-group").removeClass("has-error fail-check").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check"))})}}),$("#inputTelf").on({blur:function(e){var s=$(this).val(),o=$(this);8==s.length?$.post("/personas/v_userstelf",data={_xsrf:getCookie("_xsrf"),telf:s},function(e){$("form").find(".optional").each(function(){$(this).enable().show()}),null==e?(o.val("").focus().closest(".form-group").removeClass("has-success").addClass("has-error").find("span").removeClass("fa-check").addClass("fa fa-time"),swal({title:"Error!",text:"El nro. "+s+", está registrado!.\nPor favor use otro.",type:"error",confirmButtonText:"Continuar",closeOnConfirm:!1})):1==e?(o.closest(".form-group").removeClass("has-error").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check"),$.post("/personas/getbycellphone",data={_xsrf:getCookie("_xsrf"),telf:s},function(e){$("form").find(".person").text(e.persona).end().find(".optional").each(function(){$(this).disable().hide()})})):o.closest(".form-group").removeClass("has-error").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check")}):s.length>0&&s.length<8?o.focus().val(""):0==s.length&&o.focus().val("")}}),$("input[name=ci]").on({blur:function(e){var s=$(this),o=$(this).val();o.length>=7&&o.length<=8&&$.post("/personas/v_ci",data={_xsrf:getCookie("_xsrf"),ci:s.val()},function(e){e?(s.val("").focus().closest(".form-group").removeClass("has-success").addClass("has-error").find("span").removeClass("fa-check").addClass("fa fa-time"),swal({title:"Error!",text:"El CI: "+o+", está registrado!.\nPor favor use otro.",type:"error",confirmButtonText:"Continuar",closeOnConfirm:!1})):s.closest(".form-group").removeClass("has-error").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check")})}}),e.on({change:function(e){"Administrador"!=$(this).val()?s.enable().show():(s.find('option[value="1"]').attr("selected",!0).end().disable().hide(),o.find("select").find('option[value="-1"]').attr("selected",!0).end().end().disable().hide(),t.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),a.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide())}}),s.find("select").on({change:function(e){var s=+$(this).val();o.find("select").find('option[value="-1"]').attr("selected",!0).end().end().disable().hide(),t.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),a.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),2==s?o.enable().show():3==s?(o.enable().show(),t.enable().show()):4==s&&(o.enable().show(),a.enable().show())}}),o.find("select").on({change:function(e){var o=+$(this).val(),n=+s.find("select").val(),r=$(this).find("option:selected");t.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),a.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),-1!=o&&3==n?t.find("select").html(i(r.data("municipios"))).end().enable().show():-1!=o&&4==n&&a.find("select").html(l(r.data("centros"))).end().enable().show()}});var r=$("form"),d=$("button[type=submit]");r.on({submit:function(e){e.preventDefault(),e.stopPropagation(),d.disable().hide(),$.post("/usuarios/nuevo_usuario",data=r.form2Dict(),function(e){e?location.href="/usuarios/gestion":d.enable().show()})}})});