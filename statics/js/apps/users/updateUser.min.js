/*!
* auhtor: Luis Eduardo Miranda Barja
* (C) 2015 - mbarjaedu13@gmail.com
*/
$(function(){$(".manager-menu, .user-sub").addClass("active"),$("#cancel, .back").on({click:function(e){e.preventDefault(),location.href="/usuarios/gestion"}});var e=$(".key").data("key"),n=$("button[type=submit]"),o=$("#del");$(".key").removeAttr("data-key");var i=$("#inputRol"),t=i.closest(".form-group").next(),a=$(".redes_salud"),l=$(".municipios"),s=$(".centros_salud"),d=[],r=function(){for(var n=['<option value="-1">-- Elija Una --</option>'],o=+e.red_salud>0?+e.red_salud:+e.red,i=0;i<d.length;i++){var t=d[i];n.push('<option value="'+t.id_red+'"'+(o==t.id_red?" selected":"")+">"+t.nombre+"</option>")}return n.length>1?n.join(""):'<option value="-1">-- Sin Redes de Salud --</option>'},u=function(n){for(var o=['<option value="-1">-- Elija Uno --</option>'],i=0;i<d.length;i++){var t=d[i];if(t.id_red==n&&t.municipios.length>0){for(var a=d[i].municipios,l=0;l<a.length;l++){var s=a[l];o.push('<option value="'+s.id_mup+'"'+(+e.municipio>0&&+e.municipio==s.id_mup?" selected":"")+">"+s.nombre+"</option>")}break}}return o.length>1?o.join(""):'<option value="-1">-- Sin Municipios --</option>'},c=function(n){for(var o=['<option value="-1">-- Elija Uno -- </option>'],i=0;i<d.length;i++){var t=d[i];if(t.id_red==n&&t.centros.length>0){for(var a=d[i].centros,l=0;l<a.length;l++){var s=a[l];o.push('<option value="'+s.id_cen+'"'+(+e.centro_salud>0&&+e.centro_salud==s.id_cen?" selected":"")+">"+s.nombre+"</option>")}break}}return o.length>1?o.join(""):'<option value="-1">-- Sin Establecimientos --</option>'};$.post("/redes_salud/disponibles",data={_xsrf:getCookie("_xsrf")},function(e){"array"==$.type(e)&&(d=e,a.find("select").html(r()),p())});var h=$("#inputLogin").val();$("#inputLogin").on({blur:function(n){var o=$(this).val(),i=$(this);o.length>5&&e.login!=o?$.post("/usuarios/v_login",data={_xsrf:getCookie("_xsrf"),login:o},function(e){e?(i.val(h).focus().closest(".form-group").removeClass("has-success").addClass("has-error"),swal({title:"Error!",text:'"'+o+'", no está disponible!.\nPor favor escoja otro.',type:"error",confirmButtonText:"Continuar",closeOnConfirm:!1})):(i.closest(".form-group").removeClass("has-error").addClass("has-success"),$("button[type=submit]").enable())}):0==o.length&&i.attr({placeholder:"Debe llenar éste campo..!"})}}),i.on({change:function(e){"Administrador"!=$(this).val()?t.enable().show():(t.disable().hide(),a.find("select").html(r(d)).end().disable().hide(),l.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),s.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide())}}),t.find("select").on({change:function(e){var n=+$(this).val();a.find("select").html(r(d)).end().disable().hide(),l.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),s.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),2==n?a.enable().show():3==n?(a.enable().show(),l.enable().show()):4==n&&(a.enable().show(),s.enable().show())}}),a.find("select").on({change:function(e){var n=+$(this).val(),o=+t.find("select").val();l.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),s.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide(),-1!=n&&3==o?l.find("select").html(u(n)).end().enable().show():-1!=n&&4==o&&s.find("select").html(c(n)).end().enable().show()}});var p=function(){if(+e.alcance<1)t.disable().hide(),a.disable().hide();else if(+e.alcance>1){t.find("select").find('option[value="'+e.alcance+'"]').attr("selected",!0).end();var n=+e.red_salud>0?+e.red_salud:+e.red,o=+e.alcance;a.enable().show(),-1!=n&&3==o?l.find("select").html(u(n)).end().enable().show():-1!=n&&4==o&&s.find("select").html(c(n)).end().enable().show()}else a.disable().hide();+e.municipio<1&&l.disable().hide(),+e.centro_salud<1&&s.disable().hide()};$("form").on({submit:function(e){e.preventDefault(),e.stopPropagation();var i=$(this);n.disable().hide(),o.disable().hide(),$.post("/usuarios/modificar_usuario",data=i.form2Dict(),function(e){e?location.href="/usuarios/gestion":(n.enable().show(),o.enable().show())})}}),o.on({click:function(e){e.preventDefault(),n.disable().hide(),o.disable().hide(),$.post("/usuarios/eliminar_usuario",data={_xsrf:getCookie("_xsrf"),persona:$("input[name=persona]").val()},function(e){0==e?location.href="/usuarios/gestion":(n.enable().show(),o.enable().show())})}})});